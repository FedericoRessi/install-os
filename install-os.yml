---

- hosts: all
  become: true
  tasks:

    - name: Configure host name
      hostname:
        name: "{{ inventory_hostname }}"
      tags: dns

    - name: Generate /etc/hosts file
      template:
        src: etc/hosts.j2
        dest: /etc/hosts
      tags: dns

    - name: Install NTP service
      yum:
        name: chrony
        state: installed
      tags: ntp

    - name: Make sure NTP is started up
      systemd:
        name: chronyd
        enabled: yes
        state: restarted
      tags: ntp

    - name: Enable the OpenStack repository
      yum:
        name: centos-release-openstack-ocata
        state: installed
      tags: upgrade

    - name: Upgrade all packages
      yum: name=* state=latest
      tags: upgrade

    - name: Check for reboot hint
      shell: |
        LAST_KERNEL=$(rpm -q --last kernel | awk 'NR==1{sub(/kernel-/,""); print $1}')
        CURRENT_KERNEL=$(uname -r); if [ $LAST_KERNEL != $CURRENT_KERNEL ]; then
          echo 'reboot'
        else
          echo 'no'
        fi
      ignore_errors: true
      register: reboot_hint
      tags: upgrade

    - name: Reboot {{ inventory_hostname }} node
      shell: >
        sleep 2 &&
        shutdown -r +1 "Reboot required to update kernel."
      async: 1
      poll: 0
      ignore_errors: true
      when: reboot_hint.stdout.find("reboot") != -1
      tags: upgrade

    - name: Waiting for {{ inventory_hostname }} node to come back...
      local_action: wait_for host={{ inventory_hostname }} state=started delay=10 timeout=300
      become: false
      when: reboot_hint.stdout.find("reboot") != -1
      tags: upgrade

    - name: Install OpenStack client
      yum:
        name: python-openstackclient,openstack-selinux
        state: installed

    - name: check to see if pip is already installed
      command: "pip --version"
      ignore_errors: true
      register: pip_is_installed
      changed_when: false

    - block:
        - name: download get-pip.py
          get_url:
            url: https://bootstrap.pypa.io/get-pip.py
            dest: /tmp

        - name: install pip
          command: "python /tmp/get-pip.py"

        - name: delete get-pip.py
          file:
            path: /tmp/get-pip.py
            state: absent

      when: pip_is_installed.rc != 0

    - name: Install pexpect
      pip:
        name: pexpect
        version: 4


- hosts: control
  become: true
  environment:
    OS_USERNAME: admin
    OS_PASSWORD: 12345
    OS_PROJECT_NAME: admin
    OS_USER_DOMAIN_NAME: Default
    OS_PROJECT_DOMAIN_NAME: Default
    OS_AUTH_URL: http://control:35357/v3
    OS_IDENTITY_API_VERSION: 3

  tasks:

    - name: Install MariaDB service
      yum:
        name: mariadb,mariadb-server,python2-PyMySQL,MySQL-python 
        state: installed

    - name: Get management interface IP
      shell: >
        ifconfig eth1 | awk '/\sinet\s/{print $2}'
      register: get_management_ip

    - name: Enable access to database via the management network
      template:
        src: etc/my.cnf.d/openstack.cnf.j2
        dest: /etc/my.cnf.d/openstack.cnf

    - name: Start and enable the MariaDB service
      systemd:
        name: mariadb
        enabled: yes
        state: restarted

    - name: Enter root password for MariaDB service
      shell: |
        echo -e "\nn\nY\nY\nY\nY" | mysql_secure_installation

    - name: Install RabbitMQ service
      yum:
        name: rabbitmq-server
        state: installed

    - name: Start and enable RabbitMQ service
      systemd:
        name: rabbitmq-server
        enabled: yes
        state: started

    - name: Add openstack user to RabbitMQ service
      shell: |
        rabbitmqctl add_user openstack 1234
        rabbitmqctl set_permissions openstack ".*" ".*" ".*"

    - name: Install Memcached service
      yum:
        name: memcached,python-memcached
        state: installed

    - name: Configure Memcached service to use the management IP address
      lineinfile:
        path: "/etc/sysconfig/memcached"
        regexp: '^OPTIONS='
        line: >
          OPTIONS="-l 127.0.0.1,::1,control"

    - name: Start and enable RabbitMQ service
      systemd:
        name: memcached
        enabled: yes
        state: restarted

    - name: Create database for keystone
      mysql_db:
        name: keystone
        state: present

    - name: Grant proper access to the keystone database
      mysql_user:
        name: keystone
        host: '{{ item }}'
        password: 12345
        priv: 'keystone.*:ALL'
        state: present
      with_items:
        - 'localhost'
        - '%'

    - name: Install keystone components
      yum:
        name: openstack-keystone,httpd,mod_wsgi
        state: installed

    - name: Configure Keystone database access
      ini_file:
        path: /etc/keystone/keystone.conf
        section: database
        option: connection
        value: 'mysql+pymysql://keystone:12345@control/keystone'

    - name: Configure the Fernet token provider
      ini_file:
        path: /etc/keystone/keystone.conf
        section: token
        option: provider
        value: fernet

    - name: Populate the Identity service database
      become_user: keystone
      shell: >
        keystone-manage db_sync

    - name: Initialize Fernet key repositories
      shell: >
        keystone-manage {{ item }} --keystone-user keystone --keystone-group keystone
      with_items:
        - fernet_setup
        - credential_setup

    - name: Bootstrap the Identity service
      shell: >
        keystone-manage bootstrap --bootstrap-password 12345 \
          --bootstrap-admin-url http://control:35357/v3/ \
          --bootstrap-internal-url http://control:5000/v3/ \
          --bootstrap-public-url http://control:5000/v3/ \
          --bootstrap-region-id RegionOne

    - name: Configure the Apache HTTP server for Keystone
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^ServerName\s'
        line: ServerName control

    - name: Create a link to the /usr/share/keystone/wsgi-keystone.conf file
      file:
        src: /usr/share/keystone/wsgi-keystone.conf
        dest: /etc/httpd/conf.d/wsgi-keystone.conf
        state: link

    - name: Start the Apache HTTP service and configure it to start when the system boots
      systemd:
        name: httpd
        enabled: yes
        state: restarted

    - name: Create defautl projects
      shell: |
        openstack project show {{ item | lower }} || \
        openstack project create --domain default --description "{{ item }} Project" {{ item | lower }}
      with_items:
        - Service
        - Demo

    - name: Create the demo user
      shell: >
        openstack user show demo ||
        openstack user create --domain default --password demo demo

    - name: Create the user role
      shell: >
        openstack role show user ||
        openstack role create user

    - name: Add the user role to the demo user of the demo project
      shell: >
        openstack role add --project demo --user demo user

    - name: disable the temporary authentication token mechanism
      ini_file:
        path: /etc/keystone/keystone-paste.ini
        section: "{{ item }}"
        option: admin_token_auth
        state: absent
      with_items:
        - pipeline:public_api
        - pipeline:admin_api
        - pipeline:api_v3

    - name: Check admin user authentication
      environment:
        OS_AUTH_URL: ""
        OS_PASSWORD: ""
      expect:
        command: >
          openstack
            --os-auth-url http://control:35357/v3
            --os-project-domain-name default
            --os-user-domain-name default
            --os-project-name admin
            --os-username admin token issue
        responses:
          Password: 12345

    - name: Check demo user authentication
      environment:
        OS_AUTH_URL: ""
        OS_PASSWORD: ""
      expect:
        command: >
          openstack
            --os-auth-url http://control:5000/v3
            --os-project-domain-name default
            --os-user-domain-name default
            --os-project-name demo
            --os-username demo token issue
        responses:
          Password: demo

    - name: Provide openrc scripts directory
      file:
        path: /root/.openrc
        state: directory
        mode: 0700

    - name: Provide openrc scripts
      template:
        src: 'openrc/{{ item }}.j2'
        dest: '/root/.openrc/{{ item }}'
      with_items:
        - admin-openrc
        - demo-openrc

    - name: Test openrc scripts
      shell: |
        source /root/.openrc/{{ item }}
        openstack token issue
      with_items:
        - admin-openrc
        - demo-openrc

    - name: Create database for Glance
      mysql_db:
        name: glance
        state: present

    - name: Grant proper access to the keystone database
      mysql_user:
        name: glance
        host: '{{ item }}'
        password: 12345
        priv: 'glance.*:ALL'
        state: present
      with_items:
        - 'localhost'
        - '%'

    - name: Create glance user if it doesn't exist
      shell: >
        openstack user show glance ||
        openstack user create --domain default --password 12345 glance

    - name: Add the admin role to the glance user and service project
      command:
        openstack role add --project service --user glance admin

    - name: Create the glance service entity
      command:
        openstack service create --name glance --description "OpenStack Image" image

    - name: Create the Image service API endpoints
      shell: >
        (openstack endpoint list -f value -c Region -c 'Service Name' -c Interface | 
         grep '^RegionOne glance {{ item }}$') ||
        openstack endpoint create --region RegionOne image {{ item }} http://control:9292
      with_items:
        - public
        - internal
        - admin

    - name: Install OpenStack Glance
      yum:
        name: openstack-glance
      register: glance_installed

    - name: Configure Glance database access
      ini_file:
        path: '{{ item }}'
        section: database
        option: connection
        value: 'mysql+pymysql://glance:12345@control/glance'
      with_items:
       - /etc/glance/glance-api.conf
       - /etc/glance/glance-registry.conf

    - name: Remove Glance auth token section
      ini_file:
        path: '{{ item }}'
        section: keystone_authtoken
        state: absent
      with_items:
        - /etc/glance/glance-api.conf
        - /etc/glance/glance-registry.conf
      when: 'glance_installed.changed'

    - name: Configure Glance auth token section
      ini_file:
        path: '{{ item[0] }}'
        section: keystone_authtoken
        option: '{{ item[1].option }}'
        value: '{{ item[1].value }}'
      with_nested:
        - [ '/etc/glance/glance-api.conf',
            '/etc/glance/glance-registry.conf' ]
        - [ { option: auth_uri, value: 'http://control:5000' },
            { option: auth_url, value: 'http://control:35357' },
            { option: memcached_servers, value: 'control:11211' },
            { option: auth_type, value: password },
            { option: project_domain_name, value: default },
            { option: user_domain_name, value: default },
            { option: project_name, value: service },
            { option: username, value: glance }]

    - name: Configure Keystone auth password
      ini_file:
        path: '{{ item }}'
        section: keystone_authtoken
        option: password
        value: 12345
      with_items:
        - /etc/glance/glance-api.conf
        - /etc/glance/glance-registry.conf

    - name: Configure Glance paste-deploy
      ini_file:
        path: '{{ item }}'
        section: paste_deploy
        option: flavor
        value: keystone
      with_items:
        - /etc/glance/glance-api.conf
        - /etc/glance/glance-registry.conf

    - name: Configure the local file system store and location of image files
      ini_file:
        path: /etc/glance/glance-api.conf
        section: glance_store
        option: '{{ item.option }}'
        value: '{{ item.value }}'
      with_items:
        - { option: stores, value: file,http }
        - { option: default_store, value: file }
        - { option: filesystem_store_datadir, value: /var/lib/glance/images/ }

    - name: Populate the Image service database
      become_user: glance
      shell: >
        glance-manage db_sync

    - name: Start the Image services and configure them to start when the system boots
      systemd:
        name: openstack-glance-api
        enabled: yes
        state: restarted

    - name: Check it has Cirros image
      shell: |
        openstack image list -f value -c Name | grep '^cirros$'
      ignore_errors: true
      register: has_cirros_image

    - name: Get Cirros image
      get_url:
        url: http://download.cirros-cloud.net/0.3.5/cirros-0.3.5-x86_64-disk.img
        dest: /tmp
      register: cirros_image
      when: has_cirros_image.rc != 0

    - name: Upload the image to the Image service
      command: >
        openstack image create cirros
          --file /tmp/cirros-0.3.5-x86_64-disk.img
          --disk-format qcow2
          --container-format bare
          --public
      when: has_cirros_image.rc != 0
